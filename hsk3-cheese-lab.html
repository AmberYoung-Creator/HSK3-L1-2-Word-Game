<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HSK3 Cheese Lab ‚Äî L1 & L2 (Alexander)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .perspective { perspective: 1200px; }
    .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
    .flipcard { transform-style: preserve-3d; transition: transform .5s ease; }
    .flipcard.flipped { transform: rotateY(180deg); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-amber-50 via-yellow-50 to-white text-neutral-900">
  <div id="root"></div>

  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    // ----------------------------- Data -----------------------------
    const WORDS = [
      { id: "Âë®Êú´", hanzi: "Âë®Êú´", pinyin: "zh≈çum√≤", en: "weekend", ru: "–≤—ã—Ö–æ–¥–Ω—ã–µ", lesson: "L1" },
      { id: "ÊâìÁÆó", hanzi: "ÊâìÁÆó", pinyin: "d«ésu√†n", en: "to plan; intend", ru: "–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å; –Ω–∞–º–µ—Ä–µ–≤–∞—Ç—å—Å—è", lesson: "L1" },
      { id: "Ë∑ü‰∏ÄËµ∑", hanzi: "Ë∑ü‚Ä¶‰∏ÄËµ∑", pinyin: "gƒìn ‚Ä¶ y√¨q«ê", en: "together with sb.", ru: "–≤–º–µ—Å—Ç–µ —Å –∫–µ–º‚Äë—Ç–æ", lesson: "L1" },
      { id: "‰∏ÄÁõ¥", hanzi: "‰∏ÄÁõ¥", pinyin: "yƒ´zh√≠", en: "continuously; all along", ru: "–ø–æ—Å—Ç–æ—è–Ω–Ω–æ; –≤—Å—ë –≤—Ä–µ–º—è", lesson: "L1" },
      { id: "Ê∏∏Êàè", hanzi: "Ê∏∏Êàè", pinyin: "y√≥ux√¨", en: "game", ru: "–∏–≥—Ä–∞", lesson: "L1" },
      { id: "ÁîµËÑë", hanzi: "ÁîµËÑë", pinyin: "di√†nn«éo", en: "computer", ru: "–∫–æ–º–ø—å—é—Ç–µ—Ä", lesson: "L1" },
      { id: "‰Ωú‰∏ö", hanzi: "‰Ωú‰∏ö", pinyin: "zu√≤y√®", en: "homework", ru: "–¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ", lesson: "L1" },
      { id: "ÁùÄÊÄ•", hanzi: "ÁùÄÊÄ•", pinyin: "zhƒÅoj√≠", en: "to worry; be anxious; in a hurry", ru: "–≤–æ–ª–Ω–æ–≤–∞—Ç—å—Å—è; —Å–ø–µ—à–∏—Ç—å", lesson: "L1" },
      { id: "Â§ç‰π†", hanzi: "Â§ç‰π†", pinyin: "f√πx√≠", en: "to review", ru: "–ø–æ–≤—Ç–æ—Ä—è—Ç—å (—É—á—ë–±—É)", lesson: "L1" },
      { id: "ÂçóÊñπ", hanzi: "ÂçóÊñπ", pinyin: "n√°nfƒÅng", en: "south (southern part)", ru: "—é–≥", lesson: "L1" },
      { id: "ÂåóÊñπ", hanzi: "ÂåóÊñπ", pinyin: "bƒõifƒÅng", en: "north (northern part)", ru: "—Å–µ–≤–µ—Ä", lesson: "L1" },
      { id: "Èù¢ÂåÖ", hanzi: "Èù¢ÂåÖ", pinyin: "mi√†nbƒÅo", en: "bread", ru: "—Ö–ª–µ–±", lesson: "L1" },
      { id: "Â∏¶", hanzi: "Â∏¶", pinyin: "d√†i", en: "to bring; take; carry", ru: "–±—Ä–∞—Ç—å (—Å —Å–æ–±–æ–π); –ø—Ä–∏–Ω–æ—Å–∏—Ç—å", lesson: "L1" },
      { id: "Âú∞Âõæ", hanzi: "Âú∞Âõæ", pinyin: "d√¨t√∫", en: "map", ru: "–∫–∞—Ä—Ç–∞", lesson: "L1" },
      { id: "Êê¨ÂÆ∂", hanzi: "Êê¨ÂÆ∂", pinyin: "bƒÅnjiƒÅ", en: "to move house", ru: "–ø–µ—Ä–µ–µ–∑–∂–∞—Ç—å", lesson: "L1" },
      { id: "ËÖø", hanzi: "ËÖø", pinyin: "tu«ê", en: "leg", ru: "–Ω–æ–≥–∞", lesson: "L1" },
      { id: "ËÑö", hanzi: "ËÑö", pinyin: "ji«éo", en: "foot", ru: "—Å—Ç—É–ø–Ω—è", lesson: "L1" },
      { id: "Áñº", hanzi: "Áñº", pinyin: "t√©ng", en: "ache; painful", ru: "–±–æ–ª—å–Ω–æ; –±–æ–ª–∏—Ç", lesson: "L1" },
      { id: "Ê†ë", hanzi: "Ê†ë", pinyin: "sh√π", en: "tree", ru: "–¥–µ—Ä–µ–≤–æ", lesson: "L1" },
      { id: "ÂÆπÊòì", hanzi: "ÂÆπÊòì", pinyin: "r√≥ngy√¨", en: "easy", ru: "–ª—ë–≥–∫–∏–π", lesson: "L1" },
      { id: "Èöæ", hanzi: "Èöæ", pinyin: "n√°n", en: "difficult", ru: "—Ç—Ä—É–¥–Ω—ã–π", lesson: "L1" },
      { id: "ÁéãÂ§™Â§™", hanzi: "ÁéãÂ§™Â§™", pinyin: "W√°ng t√†itai", en: "Mrs. Wang", ru: "–≥–æ—Å–ø–æ–∂–∞ –í–∞–Ω", lesson: "L1" },
      { id: "Áßò‰π¶", hanzi: "Áßò‰π¶", pinyin: "m√¨sh≈´", en: "secretary", ru: "—Å–µ–∫—Ä–µ—Ç–∞—Ä—å", lesson: "L1" },
      { id: "ÁªèÁêÜ", hanzi: "ÁªèÁêÜ", pinyin: "jƒ´ngl«ê", en: "manager", ru: "–º–µ–Ω–µ–¥–∂–µ—Ä; –¥–∏—Ä–µ–∫—Ç–æ—Ä", lesson: "L1" },
      { id: "ÂäûÂÖ¨ÂÆ§", hanzi: "ÂäûÂÖ¨ÂÆ§", pinyin: "b√†ng≈çngsh√¨", en: "office", ru: "–æ—Ñ–∏—Å", lesson: "L1" },
      { id: "‰∏ÄËæÜËΩ¶", hanzi: "‰∏ÄËæÜËΩ¶", pinyin: "y√≠ li√†ng chƒì", en: "one car", ru: "–æ–¥–Ω–∞ –º–∞—à–∏–Ω–∞", lesson: "L1" },
      { id: "Ê•º‰∏ã", hanzi: "Ê•º‰∏ã", pinyin: "l√≥uxi√†", en: "downstairs", ru: "–≤–Ω–∏–∑—É; –Ω–∏–∂–Ω–∏–π —ç—Ç–∞–∂", lesson: "L1" },
      { id: "Êãø", hanzi: "Êãø", pinyin: "n√°", en: "to take; hold", ru: "–±—Ä–∞—Ç—å; –¥–µ—Ä–∂–∞—Ç—å", lesson: "L1" },
      { id: "‰∏ÄÊää‰ºû", hanzi: "‰∏ÄÊää‰ºû", pinyin: "y√¨ b«é s«én", en: "an umbrella", ru: "–æ–¥–∏–Ω –∑–æ–Ω—Ç", lesson: "L1" },
      { id: "ËÉñ", hanzi: "ËÉñ", pinyin: "p√†ng", en: "fat; plump", ru: "–ø–æ–ª–Ω—ã–π; —Ç–æ–ª—Å—Ç—ã–π", lesson: "L2" },
      { id: "ÂÖ∂ÂÆû", hanzi: "ÂÖ∂ÂÆû", pinyin: "q√≠sh√≠", en: "actually; in fact", ru: "–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ", lesson: "L2" },
      { id: "Áò¶", hanzi: "Áò¶", pinyin: "sh√≤u", en: "thin; slim", ru: "—Ö—É–¥–æ–π", lesson: "L2" },
      { id: "Â§ñËæπÂ§ñÈù¢", hanzi: "Â§ñËæπ/Â§ñÈù¢", pinyin: "w√†ibian / w√†imi√†n", en: "outside", ru: "—Å–Ω–∞—Ä—É–∂–∏", lesson: "L2" },
      { id: "Âäû‰∫ã", hanzi: "Âäû‰∫ã", pinyin: "b√†nsh√¨", en: "handle affairs; do work", ru: "–∑–∞–Ω–∏–º–∞—Ç—å—Å—è –¥–µ–ª–∞–º–∏; —É–ª–∞–∂–∏–≤–∞—Ç—å –¥–µ–ª–∞", lesson: "L2" },
      { id: "Áé©ÂÑø", hanzi: "Áé©ÂÑø", pinyin: "w√°nr", en: "to play; hang out", ru: "–∏–≥—Ä–∞—Ç—å; —Ä–∞–∑–≤–ª–µ–∫–∞—Ç—å—Å—è", lesson: "L2" },
      { id: "Â∑≤Áªè‰∫Ü", hanzi: "Â∑≤Áªè‚Ä¶‚Ä¶‰∫Ü", pinyin: "y«êjƒ´ng ‚Ä¶ le", en: "already ‚Ä¶", ru: "—É–∂–µ ‚Ä¶", lesson: "L2" },
      { id: "‰∏ÄÁÇπÂÑø‰πü‰∏ç", hanzi: "‰∏ÄÁÇπÂÑø‰πü‰∏ç", pinyin: "y√¨di«énr yƒõ b√π", en: "not ‚Ä¶ at all", ru: "—Å–æ–≤—Å–µ–º –Ω–µ ‚Ä¶", lesson: "L2" },
      { id: "‰∏ÄÁÇπÂÑø‰πüÊ≤°Êúâ", hanzi: "‰∏ÄÁÇπÂÑø‰πüÊ≤°Êúâ", pinyin: "y√¨di«énr yƒõ m√©iy«íu", en: "not even a little; none", ru: "—Å–æ–≤—Å–µ–º –Ω–µ—Ç ‚Ä¶", lesson: "L2" },
      { id: "Êâì‰∫ÜÁîµËØùÂ∞±ÂêÉÈ•≠", hanzi: "Êâì‰∫ÜÁîµËØùÂ∞±ÂêÉÈ•≠", pinyin: "d«é le di√†nhu√† ji√π chƒ´f√†n", en: "call and then eat immediately", ru: "–ø–æ–∑–≤–æ–Ω—é ‚Äî –∏ —Å—Ä–∞–∑—É –ø–æ–µ–¥–∏–º", lesson: "L2" },
      { id: "Á©ø‰∫ÜË°£ÊúçÂ∞±ÂéªËøêÂä®", hanzi: "Á©ø‰∫ÜË°£ÊúçÂ∞±ÂéªËøêÂä®", pinyin: "chuƒÅn le yƒ´fu ji√π q√π y√πnd√≤ng", en: "get dressed then go exercise", ru: "–Ω–∞–¥–µ–Ω—É –æ–¥–µ–∂–¥—É ‚Äî –∏ —Å—Ä–∞–∑—É –ø–æ–π–¥—É –Ω–∞ —Å–ø–æ—Ä—Ç", lesson: "L2" },
      { id: "È•≠ÂÅöÂ•Ω‰∫Ü", hanzi: "È•≠ÂÅöÂ•Ω‰∫Ü", pinyin: "f√†n zu√≤ h«éo le", en: "the meal is ready", ru: "–µ–¥–∞ –≥–æ—Ç–æ–≤–∞", lesson: "L2" },
      { id: "‰Ωú‰∏öÂÅöÂÆå‰∫Ü", hanzi: "‰Ωú‰∏öÂÅöÂÆå‰∫Ü", pinyin: "zu√≤y√® zu√≤ w√°n le", en: "homework is finished", ru: "–¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∞–Ω–æ", lesson: "L2" },
    ];
    const ALL_IDS = WORDS.map(w => w.id);

    // ----------------------------- Utilities -----------------------------
    const STORAGE_KEY = "alex-hsk3-progress-v1";

    function loadProgress() {
      try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : {}; }
      catch { return {}; }
    }
    function saveProgress(p) {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(p)); } catch {}
    }

    function updateWordProgress(p, id, correct) {
      const now = Date.now();
      const prev = p[id] || { views: 0, correct: 0, incorrect: 0, streak: 0, mastery: 0 };
      const next = { ...prev };
      next.views += 1;
      if (correct) {
        next.correct += 1;
        next.streak = (prev.streak || 0) + 1;
        if (next.streak >= 2) next.mastery = Math.min(5, (prev.mastery || 0) + 1);
      } else {
        next.incorrect += 1;
        next.streak = 0;
        next.mastery = Math.max(0, (prev.mastery || 0) - 1);
      }
      next.lastSeen = now;
      next.lastResult = correct ? "correct" : "wrong";
      return { ...p, [id]: next };
    }

    function masteryPct(progress) {
      const total = ALL_IDS.length * 5;
      const have = ALL_IDS.reduce((acc, id) => acc + (progress[id]?.mastery || 0), 0);
      return Math.round((have / total) * 100);
    }
    function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function normalizeHanzi(s){ return s.replaceAll("‚Ä¶","").replaceAll("/","").replaceAll(" ",""); }

    // Speech synthesis
    function speak(text, lang = "zh-CN", rate = 1) {
      if (typeof window === "undefined" || !("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      const vs = window.speechSynthesis.getVoices();
      const match = vs.find(v => v.lang?.toLowerCase().startsWith(lang.toLowerCase()));
      if (match) u.voice = match;
      u.lang = lang; u.rate = rate;
      window.speechSynthesis.speak(u);
    }
    function speakWord(word, alsoPinyin = true) {
      if (!word) return;
      speak(word.hanzi, "zh-CN", 0.95);
      if (alsoPinyin) setTimeout(() => speak(word.pinyin, "en-US", 0.95), 600);
    }

    // ----------------------------- UI helpers -----------------------------
    function StatPill({ label, value }) {
      return <div className="px-3 py-1 rounded-full bg-black/10 text-xs font-medium">{label}: <span className="tabular-nums">{value}</span></div>;
    }
    function Toggle({ value, onChange, labels }) {
      return (
        <div className="inline-flex rounded-xl overflow-hidden border border-black/10">
          {labels.map((lab, i) => (
            <button key={lab} onClick={()=>onChange(i)} className={"px-3 py-1 text-sm " + (i===value? "bg-yellow-300 text-black" : "bg-transparent")}>{lab}</button>
          ))}
        </div>
      );
    }

    // ----------------------------- Flashcards -----------------------------
    function Flashcards({ words, progress, setProgress, backLang }) {
      const ordered = useMemo(() => {
        return [...words].sort((a,b)=>{
          const ma = progress[a.id]?.mastery || 0;
          const mb = progress[b.id]?.mastery || 0;
          if (ma !== mb) return ma - mb;
          const la = progress[a.id]?.lastSeen || 0;
          const lb = progress[b.id]?.lastSeen || 0;
          return la - lb;
        });
      }, [words, progress]);

      const [idx, setIdx] = useState(0);
      const [flipped, setFlipped] = useState(false);
      const w = ordered[idx % ordered.length];

      useEffect(()=>{
        const onKey = (e)=>{
          if (e.key === " ") { e.preventDefault(); setFlipped(f=>!f); }
          if (e.key.toLowerCase() === "k") handleAnswer(true);
          if (e.key.toLowerCase() === "a") handleAnswer(false);
          if (e.key.toLowerCase() === "v") speakWord(w);
        };
        window.addEventListener("keydown", onKey);
        return ()=> window.removeEventListener("keydown", onKey);
      }, [w]);

      function handleAnswer(correct){
        const next = updateWordProgress(progress, w.id, correct);
        setProgress(next); saveProgress(next);
        setFlipped(false); setIdx(i=>i+1);
      }
      const backText = backLang === 0 ? w.en : w.ru;

      return (
        <div className="grid lg:grid-cols-2 gap-6">
          <div className="flex flex-col items-center">
            <div className="text-xs opacity-60 mb-2">Space=flip ¬∑ V=voice ¬∑ K=know ¬∑ A=again</div>
            <div className="w-full max-w-md aspect-[4/3] perspective">
              <div className={"relative w-full h-full cursor-pointer flipcard " + (flipped? "flipped": "")} onClick={()=>setFlipped(f=>!f)}>
                <div className="absolute inset-0 flex items-center justify-center rounded-3xl bg-gradient-to-br from-amber-100 via-yellow-100 to-amber-200 shadow-xl backface-hidden">
                  <div className="text-5xl md:text-6xl font-semibold">{w.hanzi}</div>
                </div>
                <div className="absolute inset-0 flex items-center justify-center rounded-3xl bg-neutral-900 text-white shadow-xl backface-hidden" style={{transform:"rotateY(180deg)"}}>
                  <div className="px-6 text-center">
                    <div className="text-lg opacity-80 mb-1">{w.pinyin}</div>
                    <div className="text-2xl font-medium">{backText}</div>
                    <button onClick={()=>speakWord(w)} className="mt-4 px-3 py-1 rounded-full bg-yellow-300 text-black font-medium">üîä Pronounce</button>
                  </div>
                </div>
              </div>
            </div>
            <div className="mt-4 flex gap-3">
              <button onClick={()=>handleAnswer(false)} className="px-4 py-2 rounded-xl bg-neutral-200 hover:bg-neutral-300">Again</button>
              <button onClick={()=>handleAnswer(true)} className="px-4 py-2 rounded-xl bg-emerald-500 text-white hover:bg-emerald-600">I knew it</button>
            </div>
          </div>
          <div>
            <h4 className="font-semibold mb-2">Study queue (low mastery first)</h4>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-72 overflow-auto p-2 rounded-xl bg-white/50">
              {ordered.map((x,i)=>(
                <button key={x.id} onClick={()=>{setIdx(i); setFlipped(false);}} className={"px-3 py-2 rounded-xl text-left border " + (x.id===w.id? "border-amber-400 bg-amber-50":"border-transparent hover:bg-neutral-50")}>
                  <div className="text-lg">{x.hanzi}</div>
                  <div className="text-xs opacity-60">{x.pinyin}</div>
                  <div className="mt-1 h-1 bg-neutral-200 rounded">
                    <div className="h-full bg-emerald-500 rounded" style={{width: ((progress[x.id]?.mastery||0)/5*100) + '%'}}></div>
                  </div>
                </button>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ----------------------------- Quiz -----------------------------
    function Quiz({ words, progress, setProgress, backLang }) {
      const [q, setQ] = useState(()=>makeQ());
      const [sel, setSel] = useState(null);
      const [done, setDone] = useState(false);

      function makeQ(){
        const w = pickRandom(words);
        const isHanziPrompt = Math.random() < 0.6;
        const pool = words.filter(x=>x.id!==w.id);
        const distractors = [];
        while (distractors.length < 3 && pool.length) {
          const cand = pool.splice(Math.floor(Math.random()*pool.length),1)[0];
          distractors.push(cand);
        }
        const opts = [w, ...distractors].sort(()=>Math.random()-0.5);
        return { w, isHanziPrompt, opts };
      }
      function choose(o){
        if (done) return;
        setSel(o.id);
        const correct = o.id === q.w.id;
        const next = updateWordProgress(progress, q.w.id, correct);
        setProgress(next); saveProgress(next);
        setDone(true);
        setTimeout(()=>{ setQ(makeQ()); setSel(null); setDone(false); }, 900);
      }

      return (
        <div className="grid md:grid-cols-2 gap-6">
          <div className="p-6 rounded-3xl bg-gradient-to-br from-yellow-50 to-amber-100 border">
            <div className="text-xs opacity-60 mb-2">Tip: click the speaker to hear it.</div>
            <div className="text-5xl font-semibold flex items-center gap-3">
              {q.isHanziPrompt ? (
                <>
                  <button className="px-3 py-1 rounded-full bg-yellow-300" onClick={()=>speakWord(q.w)}>üîä</button>
                  <span>{q.w.hanzi}</span>
                </>
              ) : (
                <span className="text-2xl">{backLang===0?q.w.en:q.w.ru} <span className="text-sm opacity-70">({q.w.pinyin})</span></span>
              )}
            </div>
          </div>
          <div className="grid gap-3">
            {q.opts.map(o => (
              <button key={o.id} onClick={()=>choose(o)}
                className={"p-4 rounded-2xl border text-left transition " + (sel===o.id && done ? (o.id===q.w.id? "bg-emerald-100 border-emerald-400":"bg-rose-100 border-rose-400") : "hover:bg-neutral-50")}>
                {q.isHanziPrompt ? (
                  <>
                    <div className="font-medium">{backLang===0?o.en:o.ru}</div>
                    <div className="text-xs opacity-70">{o.pinyin}</div>
                  </>
                ) : (
                  <div className="text-2xl">{o.hanzi}</div>
                )}
              </button>
            ))}
          </div>
        </div>
      );
    }

    // ----------------------------- Type-It -----------------------------
    function TypeIt({ words, progress, setProgress }) {
      const [w, setW] = useState(pickRandom(words));
      const [answer, setAnswer] = useState("");
      const [state, setState] = useState(null);

      function check(){
        const typed = answer.trim();
        const normTyped = normalizeHanzi(typed);
        const normTrue = normalizeHanzi(w.hanzi);
        const alt = w.id === "Â§ñËæπÂ§ñÈù¢" ? ["Â§ñËæπ","Â§ñÈù¢"] : [w.hanzi];
        const correct = alt.some(v => normalizeHanzi(v) === normTyped) || normTrue === normTyped;
        const next = updateWordProgress(progress, w.id, correct);
        setProgress(next); saveProgress(next);
        setState(correct ? "ok" : "no");
        setTimeout(()=>{ setW(pickRandom(words)); setAnswer(""); setState(null); }, 900);
      }

      return (
        <div className="p-6 rounded-3xl border bg-white/60">
          <div className="text-sm opacity-70 mb-2">Type the <b>Chinese characters</b> for the meaning below.</div>
          <div className="text-2xl mb-4">{w.en} <span className="text-sm opacity-60">/ {w.ru}</span></div>
          <div className="mb-3 text-sm opacity-60">Hint: {w.pinyin}</div>
          <div className="flex gap-2 items-center">
            <input value={answer} onChange={e=>setAnswer(e.target.value)} onKeyDown={e=>{if(e.key==='Enter') check();}}
              className="flex-1 px-4 py-3 rounded-2xl border" placeholder="Âú®ËøôÈáåËæìÂÖ•Ê±âÂ≠ó‚Ä¶" />
            <button onClick={check} className="px-4 py-3 rounded-2xl bg-emerald-500 text-white">Check</button>
            <button onClick={()=>speakWord(w)} className="px-3 py-3 rounded-2xl bg-yellow-300">üîä</button>
          </div>
          {state && (
            <div className={"mt-3 px-3 py-2 rounded-xl inline-block " + (state==='ok'?'bg-emerald-100 text-emerald-800':'bg-rose-100 text-rose-800')}>
              {state==='ok' ? 'Correct! ‚úÖ' : 'Try again next time ‚úó'}
            </div>
          )}
        </div>
      );
    }

    // ----------------------------- Mouse & Cheese Game -----------------------------
    function MouseCheeseGame({ words }) {
      const canvasRef = useRef(null);
      const [running, setRunning] = useState(false);
      const [score, setScore] = useState(0);
      const [overlay, setOverlay] = useState(null);
      const [speed, setSpeed] = useState(140);

      const dirRef = useRef({ x: 1, y: 0 });
      const snakeRef = useRef([{ x: 5, y: 10 }]);
      const cheeseRef = useRef({ x: 12, y: 10 });
      const grid = 20; const size = 22;

      useEffect(()=>{
        function onKey(e){
          if (e.key.startsWith("Arrow")) e.preventDefault();
          const d = dirRef.current;
          if (e.key === "ArrowUp" && d.y !== 1) dirRef.current = { x: 0, y: -1 };
          if (e.key === "ArrowDown" && d.y !== -1) dirRef.current = { x: 0, y: 1 };
          if (e.key === "ArrowLeft" && d.x !== 1) dirRef.current = { x: -1, y: 0 };
          if (e.key === "ArrowRight" && d.x !== -1) dirRef.current = { x: 1, y: 0 };
        }
        window.addEventListener("keydown", onKey);
        return ()=> window.removeEventListener("keydown", onKey);
      }, []);

      useEffect(()=>{
        if (!running) return;
        const ctx = canvasRef.current?.getContext("2d");
        if (!ctx) return;
        let raf; let last = 0;
        function loop(ts){
          if (ts - last > speed) { step(); last = ts; draw(); }
          raf = requestAnimationFrame(loop);
        }
        function draw(){
          ctx.clearRect(0,0, grid*size, grid*size);
          ctx.fillStyle = "#FEF3C7"; ctx.fillRect(0,0,grid*size,grid*size);
          ctx.fillStyle = "#FDE68A";
          for (let i=0;i<80;i++){ const x=Math.random()*grid*size; const y=Math.random()*grid*size; ctx.globalAlpha=0.03; ctx.beginPath(); ctx.arc(x,y,Math.random()*6+2,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; }
          // cheese
          ctx.fillStyle = "#F59E0B";
          ctx.fillRect(cheeseRef.current.x*size, cheeseRef.current.y*size, size, size);
          // mouse
          ctx.fillStyle = "#374151";
          for (const s of snakeRef.current) ctx.fillRect(s.x*size, s.y*size, size, size);
        }
        function step(){
          const head = { ...snakeRef.current[0] };
          head.x = (head.x + dirRef.current.x + grid) % grid;
          head.y = (head.y + dirRef.current.y + grid) % grid;
          if (snakeRef.current.some((s,i)=> i>0 && s.x===head.x && s.y===head.y)) { gameOver(); return; }
          snakeRef.current = [head, ...snakeRef.current.slice(0, -1)];
          if (head.x === cheeseRef.current.x && head.y === cheeseRef.current.y){
            setScore(s=>s+1);
            snakeRef.current.push({ ...snakeRef.current[snakeRef.current.length-1] });
            cheeseRef.current = randomFreeSpot();
            const word = pickRandom(words);
            setOverlay(word); speakWord(word);
            setTimeout(()=> setOverlay(null), 1800);
            setSpeed(v => Math.max(80, v-3));
          }
        }
        function randomFreeSpot(){
          while(true){
            const p = { x: Math.floor(Math.random()*grid), y: Math.floor(Math.random()*grid) };
            if (!snakeRef.current.some(s=>s.x===p.x && s.y===p.y)) return p;
          }
        }
        function gameOver(){ setRunning(false); }
        draw(); raf = requestAnimationFrame(loop);
        return ()=> cancelAnimationFrame(raf);
      }, [running, speed, words]);

      function start(){
        snakeRef.current = [{ x: 5, y: 10 }];
        dirRef.current = { x: 1, y: 0 };
        cheeseRef.current = { x: 12, y: 10 };
        setScore(0); setSpeed(140); setOverlay(null);
        setRunning(true);
      }

      return (
        <div className="flex flex-col items-center gap-3">
          <canvas ref={canvasRef} width={20*22} height={20*22} className="rounded-3xl border shadow-inner bg-amber-50"></canvas>
          <div className="flex items-center gap-3">
            <button onClick={start} className="px-4 py-2 rounded-xl bg-amber-400 hover:bg-amber-500 text-black font-semibold">{running? "Restart":"Start"} üßÄ</button>
            <StatPill label="Score" value={score} />
            <div className="text-xs opacity-60">Use arrow keys to move the üê≠ and eat the üßÄ</div>
          </div>
          {overlay && (
            <div className="px-4 py-2 rounded-2xl bg-neutral-900 text-white">
              <div className="text-xl">{overlay.hanzi}</div>
              <div className="text-sm opacity-80">{overlay.pinyin}</div>
            </div>
          )}
        </div>
      );
    }

    // ----------------------------- Root App -----------------------------
    function ToggleLesson({ value, onChange }){
      return <Toggle value={value} onChange={onChange} labels={["L1","L2","All"]} />;
    }

    function App(){
      const [progress, setProgress] = useState({});
      const [tab, setTab] = useState("flash");
      const [langBack, setLangBack] = useState(0); // 0 en, 1 ru
      const [lessonFilter, setLessonFilter] = useState(2);

      useEffect(()=>{ setProgress(loadProgress()); }, []);

      const filteredWords = useMemo(()=> WORDS.filter(w => (lessonFilter===2 ? true : (lessonFilter===0 ? w.lesson==='L1' : w.lesson==='L2'))), [lessonFilter]);
      const mastered = ALL_IDS.filter(id => (progress[id]?.mastery||0) >= 4).length;
      const pct = masteryPct(progress);

      function resetProgress(){ if (!confirm("Reset all progress?")) return; saveProgress({}); setProgress({}); }

      return (
        <div>
          <header className="sticky top-0 z-10 backdrop-blur bg-white/60 border-b">
            <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <span className="text-2xl">üê≠üßÄ</span>
                <div>
                  <h1 className="text-xl md:text-2xl font-extrabold leading-tight">HSK3 Cheese Lab ‚Äî L1 & L2</h1>
                  <div className="text-xs opacity-70">for Alexander ¬∑ Chinese Character Recognition</div>
                </div>
              </div>
              <div className="flex items-center gap-3">
                <Toggle value={langBack} onChange={setLangBack} labels={["EN","RU"]} />
                <button onClick={resetProgress} className="px-3 py-1 rounded-xl border">Reset</button>
              </div>
            </div>
          </header>

          <main className="max-w-6xl mx-auto px-4 py-6 grid lg:grid-cols-[260px,1fr] gap-6">
            <aside className="space-y-5">
              <section className="p-4 rounded-2xl border bg-white/70">
                <h3 className="font-semibold mb-2">Progress</h3>
                <div className="text-sm flex items-center gap-2 mb-2">
                  <StatPill label="Mastered‚â•4/5" value={mastered + "/" + ALL_IDS.length} />
                  <StatPill label="Overall" value={pct + "%"} />
                </div>
                <div className="h-2 bg-neutral-200 rounded"><div className="h-full bg-emerald-500 rounded" style={{width: pct + '%'}}></div></div>
              </section>
              <section className="p-4 rounded-2xl border bg-white/70">
                <h3 className="font-semibold mb-3">Filter by lesson</h3>
                <ToggleLesson value={lessonFilter} onChange={setLessonFilter} />
                <div className="mt-4 text-xs opacity-70">Cards shown: {filteredWords.length}</div>
              </section>
              <section className="p-4 rounded-2xl border bg-white/70">
                <h3 className="font-semibold mb-2">How to use</h3>
                <ul className="text-sm list-disc pl-5 space-y-1">
                  <li>Flashcards: Space to flip, K = knew, A = again, V = voice.</li>
                  <li>Quiz: click to choose; speaker to pronounce.</li>
                  <li>Type‚ÄëIt: type Chinese characters (Enter to submit).</li>
                  <li>Game: arrow keys to move the mouse; eat cheese to hear a word.</li>
                </ul>
              </section>
            </aside>

            <section className="space-y-5">
              <nav className="flex gap-2">
                {[
                  { id: "flash", label: "Flashcards" },
                  { id: "quiz", label: "Quiz" },
                  { id: "type", label: "Type‚ÄëIt" },
                  { id: "game", label: "Mouse & Cheese" },
                ].map(t => (
                  <button key={t.id} onClick={()=>setTab(t.id)} className={"px-4 py-2 rounded-2xl border " + (tab===t.id? "bg-amber-200 border-amber-300":"bg-white hover:bg-neutral-50")}>{t.label}</button>
                ))}
              </nav>

              {tab === "flash" && <Flashcards words={filteredWords} progress={progress} setProgress={setProgress} backLang={langBack} />}
              {tab === "quiz" && <Quiz words={filteredWords} progress={progress} setProgress={setProgress} backLang={langBack} />}
              {tab === "type" && <TypeIt words={filteredWords} progress={progress} setProgress={setProgress} />}
              {tab === "game" && <MouseCheeseGame words={filteredWords} />}

              <section className="p-4 rounded-2xl border bg-white/70">
                <h3 className="font-semibold mb-2">Wordlist (L1 & L2)</h3>
                <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-72 overflow-auto">
                  {filteredWords.map(w => (
                    <div key={w.id} className="p-3 rounded-xl border bg-white/60">
                      <div className="text-lg font-semibold">{w.hanzi}</div>
                      <div className="text-xs opacity-70">{w.pinyin} ¬∑ {w.lesson}</div>
                      <div className="text-sm">{w.en}</div>
                      <div className="text-sm opacity-70">{w.ru}</div>
                    </div>
                  ))}
                </div>
              </section>
            </section>
          </main>

          <footer className="max-w-6xl mx-auto px-4 py-8 text-xs opacity-70">
            Built with üíõ for Alexander ¬∑ Uses your browser's speech feature for pronunciation. Voices vary by device.
          </footer>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
